version: 1.0.{build}

environment:
  PATH: 'C:\msys64\mingw64\bin;C:\msys64\usr\bin\;%PATH%'
  MSYSTEM: 'MSYS'
  MSYS: 'winsymlinks=lnk'
  CCACHE_PATH: 'C:\msys64\mingw64\bin'
  CCACHE_DIR: '%APPVEYOR_BUILD_FOLDER%\.ccache'
  CC: 'ccache gcc'
  CXX: 'ccache g++'

branches:
  only:
    - master
    - auto

platform:
  - x64

cache:
  - .servo
  - .cargo
  - .ccache

install:
  - set
    # Check if commit in auto branch exists in master, if exists build will be canceled.
  - cmd: >-
      for /f %%i in ('git branch -r origin/master --contain %APPVEYOR_REPO_COMMIT%') do set git_status=%%i

      IF %APPVEYOR_REPO_BRANCH%==auto (IF [%git_status%]==[origin/master] EXIT -1)
  - bash -lc "echo $MSYSTEM; pacman --needed --noconfirm -Sy pacman-mirrors"
  - bash -lc "pacman --noconfirm -Sy"
  - bash -lc "pacman -Sy --needed --noconfirm git mingw-w64-x86_64-toolchain mingw-w64-x86_64-freetype mingw-w64-x86_64-icu mingw-w64-x86_64-nspr mingw-w64-x86_64-ca-certificates mingw-w64-x86_64-expat mingw-w64-x86_64-cmake mingw-w64-x86_64-ccache tar diffutils patch patchutils make python2-setuptools"
  - bash -lc "easy_install-2.7 pip virtualenv"
  - bash -lc "mv /mingw64/bin/python2.exe /mingw64/bin/python2-mingw64.exe"
  - bash -lc "mv /mingw64/bin/python2.7.exe /mingw64/bin/python2.7-mingw64.exe"
  - ln -s -f -v /mingw64/bin/ccache gcc  
  - ln -s -f -v /mingw64/bin/ccache g++
  - ln -s -f -v /mingw64/bin/ccache cc
  - ln -s -f -v /mingw64/bin/ccache c++
  - ln -s -f -v /mingw64/bin/ccache x86_64-w64-mingw32-gcc
  - ln -s -f -v /mingw64/bin/ccache x86_64-w64-mingw32-g++
  - ln -s -f -v /mingw64/bin/ccache x86_64-w64-mingw32-c++

# Uncomment these lines to expose RDP access information to the build machine in the build log.
#init:
#  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))
#
#on_finish:
#  - ps: $blockRdp = $true; iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

build_script:
  - cmd: >-
      set MSYSTEM=MINGW64

      bash -lc "cd $APPVEYOR_BUILD_FOLDER; ./mach build -d -v && ./mach test-unit"

on_finish:
  - ccache -s

test: off
